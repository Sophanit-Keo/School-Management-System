@page
@model school_management_system.Pages.Admin.Classes.AddClassModel
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Add-Class";
}

<main class="main-content">
    <div id="app">
        <div class="container">
            <header>
                <h1>Class Schedule Management</h1>
                <div class="header-actions">
                    <button id="addGroupBtn" class="btn btn-primary">Add Group</button>
                    <button id="addRoomBtn" class="btn btn-primary">Add Room</button>
                </div>
            </header>

            <div class="group-selector"> 
            <form method="get">
                <label asp-for="SelectedGroup">Select Group:</label>
                <select asp-for="SelectedGroup" asp-items="Model.ListGroups" onchange="this.form.submit()" required>
                    <option selected>-- Select a Group --</option>
                </select>
            </form>
</div>

<div id="scheduleSection" class="schedule-section">
    <div class="section-header">
        <h2>Class Schedule</h2>
        <button id="addClassBtn" class="btn btn-primary">Add Class</button>
    </div>

    <div class="table-container">
        <table id="scheduleTable">
            <thead>
                <tr>
                    <th>Group</th>
                    <th>Subject</th>
                    <th>Teacher</th>
                    <th>Room</th>
                    <th>Day of Week</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="scheduleTableBody">
                            @if (Model != null && Model.ExistingTimetables.Count()>0)
                            {
                                foreach (var item in Model.ExistingTimetables)
                                {
                                <tr data-group="@item.Group?.Name">
                                    <td>@item.Group?.Name</td>
                                    <td>@item.Subject?.Name</td>
                                    <td>@($"{item.Teacher?.FirstName} {item.Teacher?.LastName}")</td>
                                    <td>@item.Classroom?.Name</td>
                                    <td>@item.DayOfWeek</td>
                                    <td>@item.StartTime.ToString(@"hh:mm")</td>
                                    <td>@item.EndTime.ToString(@"hh:mm")</td>
                                    <td>
                                        <form method="post" asp-page-handler="Delete" asp-route-id="@item.Id">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                                }
                            }
                            else
                            {
                        <tr>
                            <td colspan="8" class="text-center text-muted">No class schedules found</td>
                        </tr>
                            }
            </tbody>
        </table>
    </div>
</div>

    <!-- Add/Edit Class Modal -->
    <div id="classModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Class</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <form id="classForm" method="POST" asp-page-handler="AddClass">
            <input type="hidden" id="groupId" name="SelectedGroup" value="" style="display:none">
                <div class="form-group">
                    <label asp-for="SelectedSubject">Subject:</label>
                    <select asp-for="SelectedSubject" asp-items="Model.ListSubject" required>
                        <option selected>-- Select Subject --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label asp-for="SelectedTeacher">Teacher:</label>
                    <select asp-for="SelectedTeacher" asp-items="Model.ListTeacher" required>
                        <option selected>-- Select Teacher --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label asp-for="SelectedClassroom">Teacher:</label>
                    <select asp-for="SelectedClassroom" asp-items="Model.ListClassroom" required>
                        <option selected>-- Select Room --</option>
                    </select>
                </div>


                <div class="form-group">
                    <label asp-for="Timetable.DayOfWeek">Day of Week:</label>
                    <select asp-for="Timetable.DayOfWeek" required>
                        <option value="">-- Select Day --</option>
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                        <option value="Sunday">Sunday</option>
                    </select>
                </div>

                <div class="form-group">
                    <label asp-for="Timetable.StartTime">Start Time:</label>
                    <input type="time" asp-for="Timetable.StartTime" required>
                </div>

                <div class="form-group">
                    <label asp-for="Timetable.EndTime">End Time:</label>
                    <input type="time" asp-for="Timetable.EndTime" required>
                </div>

                <div class="form-actions">
                    <a asp-page="AddClass" type="button" class="btn btn-secondary" id="cancelBtn">Cancel</a>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Group</h2>
                <button class="close-btn" id="closeGroupModal">&times;</button>
            </div>
            <form method="POST" asp-page-handler="AddGroup">
                <div class="form-group">
                    <label asp-for="Group.Name">Group Name:</label>
                    <input type="text" asp-for="Group.Name" placeholder="e.g., 12-A" required>
                </div>

                <div class="form-actions">
                    <a asp-page="AddClass" type="button" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Create Group</button>
                </div>
            </form>
        </div>
    </div>
    <div id="roomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Room</h2>
                <button class="close-btn" id="closeRoomModal">&times;</button>
            </div>
            <form method="POST" asp-page-handler="AddRoom">
                <div class="form-group">
                    <label asp-for="Classroom.Name">Room Name:</label>
                    <input type="text" asp-for="Classroom.Name" placeholder="e.g., 101-A" required>
                </div>

                <div class="form-actions">
                    <a asp-page="AddClass" type="button" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Create Room</button>
                </div>
            </form>
        </div>
    </div>
</main>

@section Styles {
        <link rel="stylesheet" href="/css/admin-css/admin.css" />
        <link rel="stylesheet" href="/css/admin-css/Class.css" />
        <link rel="stylesheet" href="/css/shared-css/css/reset.css">
        <link rel="stylesheet" href="/css/shared-css/typography.css">
        <link rel="stylesheet" href="/css/shared-css/components.css">
        <link rel="stylesheet" href="/css/shared-css/layout.css">
}

@section Scripts {
    <script>
        // Toggle visibility of modals
        document.getElementById("addGroupBtn").addEventListener("click", function() {
            document.getElementById("groupModal").style.display = "block";
        });
        document.getElementById("closeGroupModal").addEventListener("click", function() {
            document.getElementById("groupModal").style.display = "none";
        });
        
        document.getElementById("addRoomBtn").addEventListener("click", function() {
            document.getElementById("roomModal").style.display = "block";
        });
        document.getElementById("closeRoomModal").addEventListener("click", function() {
            document.getElementById("roomModal").style.display = "none";
        });

        document.getElementById("addClassBtn").addEventListener("click", function() {
            document.getElementById("classModal").style.display = "block";
        });
        document.getElementById("closeModal").addEventListener("click", function() {
            document.getElementById("classModal").style.display = "none";
        });
        document.addEventListener('DOMContentLoaded', () => {
            const groupSelect = document.querySelector('select[name="SelectedGroup"]');
            const groupIdInput = document.getElementById('groupId');

            groupSelect.addEventListener('change', () => {
                groupIdInput.value = groupSelect.value || '';
            });
            groupIdInput.value = groupSelect.value || '';
        });
        document.addEventListener('DOMContentLoaded', function () {
        const groupSelector = document.getElementById('groupSelector');
        const scheduleTableBody = document.getElementById('scheduleTableBody');
        const scheduleRows = scheduleTableBody.getElementsByTagName('tr');

        // Event listener to filter rows based on selected group
            groupSelector.addEventListener('change', function () {
                const selectedGroup = groupSelector.value;
                for (let row of scheduleRows) {
                    const rowGroup = row.getAttribute('data-group');
                    if (selectedGroup === '' || rowGroup === selectedGroup) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        });
    </script>
}
